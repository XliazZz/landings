---
import { galleryItems } from "../../../data/shadow-studio/gallery.ts";

interface Props {
  id: number;
  name: string; // Cambiado de 'title' a 'name' según tu interfaz
  date: string;
  artist: string;
  rating: number;
  text: string;
  category?: string;
  location?: string;
  index?: number;
}

const {
  id,
  name,
  date,
  artist,
  rating,
  text,
  category,
  location,
  index = 0,
} = Astro.props;

const MAX_RATING = 5;
const rawRating = typeof rating === "number" ? rating : 5;
const clampedRating = Math.min(Math.max(rawRating, 0), MAX_RATING);
const displayRating = clampedRating.toFixed(1);
const stars = Array.from({ length: MAX_RATING });
const delay = `${index * 100}ms`;

let testimonialImage = galleryItems.find(
  (item) => item.artist === artist && item.category === category?.toLowerCase()
)?.image;

if (!testimonialImage) {
  testimonialImage = galleryItems.find((item) => item.artist === artist)?.image;
}

if (!testimonialImage && galleryItems.length > 0) {
  testimonialImage = galleryItems[0].image;
}

const lightboxTitle = `${category || "Tatuaje"} por ${artist}`;
---

<div
  class="testimonial-card group relative w-full max-w-lg overflow-hidden rounded-xl border border-white/10 bg-card-dark p-3.5 md:p-10 shadow-lg shadow-black/20 transition-all duration-500 ease-out hover:-translate-y-2 hover:border-primary/30 hover:shadow-2xl hover:shadow-primary/10 opacity-0 translate-y-2"
  style={`--animation-delay: ${delay};`}
>
  <div
    class="absolute inset-0 bg-gradient-to-br from-primary/10 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100 pointer-events-none -z-0"
  >
  </div>

  <div class="relative z-10 flex h-full flex-col">
    <div class="flex-shrink-0">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3
            class="text-xl font-bold text-white transition-colors duration-300 group-hover:text-white"
          >
            {name || "Testimonio"}
          </h3>
          <div
            class="mt-1 flex flex-wrap items-center gap-2 text-xs text-gray-400"
          >
            <span>{date || "Marzo 2024"}</span>
            <span class="text-white/20">•</span>
            <span>
              Artista:
              <span
                class="font-medium text-white/80 transition-colors duration-300 group-hover:text-aux-secondary"
              >
                {" "}
                {artist || "Joel Luke"}
              </span>
            </span>
          </div>
        </div>

        <div class="flex flex-col items-end gap-1">
          <div
            class="flex items-center gap-1.5"
            aria-label={`Valoración ${displayRating} sobre ${MAX_RATING}`}
          >
            <div class="flex items-center gap-0.5">
              {
                stars.map((_, index) => (
                  <svg
                    class={`h-5 w-5 transition-transform duration-500 ease-out ${
                      index < clampedRating
                        ? "text-aux-secondary"
                        : "text-white/15"
                    } ${index < clampedRating ? "group-hover:scale-110" : ""}`}
                    style={`transition-delay: ${index * 50}ms`}
                    aria-hidden="true"
                  >
                    <use href="./shadow-studio-Sprite.svg#star" />
                  </svg>
                ))
              }
            </div>
            <span class="text-sm font-semibold text-white">
              {displayRating}
            </span>
          </div>
          <span class="sr-only">
            {`Puntuación ${displayRating} de ${MAX_RATING}`}
          </span>
        </div>
      </div>
    </div>

    <div class="my-6 flex-grow">
      <blockquote
        class="border-l-2 border-primary/50 pl-4 transition-colors duration-500 ease-out group-hover:border-aux-secondary"
      >
        <p
          class="text-base leading-relaxed text-gray-300 transition-colors duration-300 group-hover:text-white/90"
        >
          “{
            text ||
              "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec metus vel ante feugiat placerat. Nullam nec metus vel ante feugiat placerat."
          }“
        </p>
      </blockquote>

      <div class="mt-5 flex flex-wrap gap-x-3 gap-y-2 text-xs">
        <div
          class="flex items-center gap-1.5 rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-primary transition-colors duration-300 hover:bg-primary/20 hover:border-primary/50"
        >
          <svg class="h-5 w-5" aria-hidden="true">
            <use href="./shadow-studio-Sprite.svg#category"></use>
          </svg>
          <span class="font-extrabold">
            {category || "Realismo"}
          </span>
        </div>

        <div
          class="flex items-center gap-1.5 rounded-full border border-white/20 bg-white/10 px-3 py-1 text-white/80 transition-colors duration-300 hover:bg-white/20 hover:border-white/40"
        >
          <svg class="h-5 w-5" aria-hidden="true">
            <use href="./shadow-studio-Sprite.svg#body"></use>
          </svg>
          <span class="font-extrabold">
            {location || "Antebrazo"}
          </span>
        </div>
      </div>
    </div>

    <div class="mt-auto flex flex-shrink-0 items-end justify-between gap-4">
      <div
        class="flex flex-col items-center gap-2 text-center text-aux-secondary opacity-60 transition-opacity duration-300 group-hover:opacity-100"
      >
        <svg class="h-5 w-5" aria-hidden="true">
          <use href="./shadow-studio-Sprite.svg#certificate"></use>
        </svg>
        <span class="text-[0.6rem] font-semibold uppercase tracking-widest">
          Testimonio Auténtico
        </span>
      </div>

      <button
        class="group/link inline-flex items-center gap-2 text-sm font-medium text-white/60 transition-colors duration-300 hover:text-aux-secondary active:text-primary cursor-pointer"
        onclick={`openLightbox('${testimonialImage}', '${lightboxTitle}', '${artist}')`}
        type="button"
      >
        <span class="relative">
          Ver tatuaje
          <span
            class="absolute bottom-0 left-0 h-[1px] w-0 bg-aux-secondary transition-all duration-300 group-hover/link:w-full"
          ></span>
        </span>
        <svg
          class="h-5 w-5 transition-transform duration-300 ease-out group-hover/link:translate-x-1 group-hover/link:text-aux-secondary"
          aria-hidden="true"
        >
          <use href="./shadow-studio-Sprite.svg#arrow-right"></use>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  const observerOptions = {
    root: null,
    rootMargin: "0px",
    threshold: 0.1,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add("is-visible");
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll(".testimonial-card").forEach((el) => {
    observer.observe(el);
  });
</script>

<style>
  .testimonial-card {
    will-change: opacity, transform, filter;
  }

  .testimonial-card.is-visible {
    animation: revealCard 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    animation-delay: var(--animation-delay, 0ms);
  }

  @keyframes revealCard {
    0% {
      opacity: 0;
      transform: translateY(30px) scale(0.98);
      filter: blur(4px);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
  }
</style>
