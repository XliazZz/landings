---
import { galleryItems, categories } from "../../data/shadow-studio/gallery";
import GallerySlider from "./gallery/GallerySlider.astro";
---

<section
  id="gallery-section"
  class="relative w-full bg-primarybg py-24 md:py-36 overflow-hidden"
>
  <div class="absolute inset-0 opacity-[0.02] pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');"></div>
  <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-primary/5 blur-[120px] rounded-full pointer-events-none"></div>

  <div class="container mx-auto px-6 relative z-10">
    
    <header class="flex flex-col lg:flex-row lg:items-end justify-between gap-10 mb-16 md:mb-24">
      
      <div class="max-w-3xl relative pl-6 border-l-2 border-aux-secondary/30 animate-on-scroll opacity-0 translate-x-[-20px] transition-all duration-1000 ease-out">
        <span class="text-aux-secondary text-[10px] font-bold tracking-[0.4em] uppercase mb-4 block">
          Portafolio Selecto
        </span>
        <h2 class="text-5xl md:text-7xl font-black uppercase text-white tracking-tighter leading-[0.9]">
          El Arte de <br/>
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-aux-primary via-white to-aux-secondary">
            Eternizar
          </span>
        </h2>
        <p class="mt-6 text-gray-400 font-light text-sm md:text-base max-w-lg leading-relaxed">
          Una colección curada de nuestras piezas más recientes. Filtra por estilo para encontrar la inspiración de tu próxima obra.
        </p>
      </div>

      <div class="animate-on-scroll opacity-0 translate-y-8 transition-all duration-1000 ease-out delay-200">
        <nav class="relative inline-flex flex-wrap items-center justify-center p-1.5 rounded-full bg-secondarybg/80 backdrop-blur-md border border-white/5 shadow-2xl z-0">
          
          <div 
            id="filter-pill"
            class="absolute top-1.5 bottom-1.5 left-0 rounded-full bg-aux-secondary shadow-[0_0_15px_-3px_rgba(227,160,70,0.4)] transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) -z-10"
            style="width: 0; opacity: 0;"
          ></div>

          {categories.map((cat, index) => (
            <button
              data-filter={cat.id}
              class={`filter-btn relative px-6 py-2.5 rounded-full text-xs font-bold uppercase tracking-wider transition-colors duration-300 z-10
              ${index === 0 
                ? "text-primarybg active-filter cursor-default" // Activo: cursor-default
                : "text-gray-400 hover:text-white cursor-pointer" // Inactivo: cursor-pointer
              }`}
            >
              {cat.label}
            </button>
          ))}
        </nav>
      </div>
    </header>

    <div class="relative w-full md:px-0 animate-fade-in-up min-h-[400px] md:min-h-[500px]">
      <GallerySlider items={galleryItems} />
    </div>

    <div id="no-results" class="hidden py-32 text-center">
      <div class="inline-block p-4 rounded-full bg-secondarybg border border-white/5 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
      </div>
      <p class="text-gray-400 text-sm font-light tracking-wide">No encontramos piezas en esta categoría por el momento.</p>
    </div>

  </div>

  <div id="lightbox" class="fixed inset-0 z-[100] bg-[#050505]/95 backdrop-blur-md hidden opacity-0 transition-opacity duration-500 flex items-center justify-center p-4">
    <button onclick="closeLightbox()" class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors z-50 p-2 group">
      <div class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center group-hover:bg-white/10 transition-all">
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </div>
    </button>
    <div class="relative max-w-7xl max-h-[90vh] w-full flex flex-col items-center">
       <img id="lightbox-img" src="" class="max-w-full max-h-[80vh] object-contain shadow-2xl shadow-black" alt="Full screen tattoo">
       <div class="mt-8 text-center animate-fade-in-up">
         <span class="block text-aux-secondary text-[10px] font-bold tracking-[0.3em] uppercase mb-2">Artista</span>
         <h3 id="lightbox-title" class="text-3xl font-bold text-white uppercase tracking-tighter mb-1"></h3>
         <p id="lightbox-artist" class="text-gray-400 text-sm font-light italic"></p>
       </div>
    </div>
  </div>

</section>

<script is:inline>
  const filterBtns = document.querySelectorAll(".filter-btn");
  const pill = document.getElementById("filter-pill");
  
  function movePillTo(targetBtn) {
    if (!pill || !targetBtn) return;
    const width = targetBtn.offsetWidth;
    const left = targetBtn.offsetLeft;
    pill.style.width = `${width}px`;
    pill.style.transform = `translateX(${left}px)`;
    pill.style.opacity = '1';
  }

  const initialActive = document.querySelector(".active-filter");
  if (initialActive) {
    setTimeout(() => movePillTo(initialActive), 100);
  }

  filterBtns.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      
      // Si ya está activo, no hacer nada (evita recargas innecesarias y el click en 'default')
      if (btn.classList.contains("active-filter")) return;

      movePillTo(btn);

      // --- 1. RESETEAR TODOS LOS BOTONES (INACTIVOS) ---
      filterBtns.forEach((b) => {
        // Quitamos clases activas
        b.classList.remove("text-primarybg", "active-filter", "cursor-default");
        // Agregamos clases inactivas (gris, hover blanco, puntero)
        b.classList.add("text-gray-400", "hover:text-white", "cursor-pointer");
      });
      
      // --- 2. ACTIVAR EL BOTÓN CLICKEADO ---
      // Quitamos clases inactivas
      btn.classList.remove("text-gray-400", "hover:text-white", "cursor-pointer");
      // Agregamos clases activas (color oscuro, marcador activo, cursor por defecto)
      btn.classList.add("text-primarybg", "active-filter", "cursor-default");
      
      btn.blur();

      const filterValue = btn.getAttribute("data-filter");
      const event = new CustomEvent("filter-gallery", {
        detail: { category: filterValue }
      });
      document.dispatchEvent(event);
    });
  });

  window.addEventListener('resize', () => {
      const active = document.querySelector(".active-filter");
      if(active) movePillTo(active);
  });

  /* --- LIGHTBOX Y SCROLL REVEAL (Igual que antes) --- */
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightbox-img");
  const lightboxTitle = document.getElementById("lightbox-title");
  const lightboxArtist = document.getElementById("lightbox-artist");

  window.openLightbox = (src, title, artist) => {
    lightboxImg.src = src;
    lightboxTitle.textContent = title;
    lightboxArtist.textContent = artist;
    lightbox.classList.remove("hidden");
    requestAnimationFrame(() => lightbox.classList.remove("opacity-0"));
    document.body.style.overflow = "hidden";
  };

  window.closeLightbox = () => {
    lightbox.classList.add("opacity-0");
    setTimeout(() => {
      lightbox.classList.add("hidden");
      lightboxImg.src = ""; 
    }, 500);
    document.body.style.overflow = "auto"; 
  };

  lightbox.addEventListener("click", (e) => {
    if (e.target === lightbox) window.closeLightbox();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
      window.closeLightbox();
    }
  });

  const observerOptions = { root: null, rootMargin: "0px", threshold: 0.1 };
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.remove("opacity-0", "translate-y-8", "translate-x-[-20px]");
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  document.querySelectorAll(".animate-on-scroll").forEach((el) => observer.observe(el));
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(40px); filter: blur(4px); }
    to { opacity: 1; transform: translateY(0); filter: blur(0); }
  }
</style>