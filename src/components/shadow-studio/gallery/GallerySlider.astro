---
import 'keen-slider/keen-slider.min.css';

interface Props {
  items: Array<{
    id: number;
    category: string;
    image: string;
    title: string;
    artist: string;
  }>;
}

const { items } = Astro.props;
---

<div class="relative group px-6 md:px-0 pb-8">
  <div
    id="keen-slider"
    class="keen-slider overflow-visible"
    style="opacity: 0; transition: opacity 0.5s ease;"
  >
    {
      items.map((item) => (
        <div
          class="keen-slider__slide relative aspect-[3/4] md:aspect-[4/5] overflow-hidden rounded-sm cursor-pointer gallery-slide"
          data-category={item.category}
          data-image={item.image}
          data-title={item.title}
          data-artist={item.artist}
          onclick={`openLightbox('${item.image}', '${item.title}', '${item.artist}')`}
        >
          <img
            src={item.image}
            alt={item.title}
            loading="lazy"
            class="w-full h-full object-cover transition-transform duration-700 hover:scale-110 filter grayscale-[20%] hover:grayscale-0"
          />

          <div class="absolute inset-0 bg-gradient-to-t from-primarybg/90 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
            <p class="text-aux-secondary text-[10px] font-bold uppercase tracking-widest mb-2">
              {item.category}
            </p>
            <h3 class="text-xl font-bold text-white uppercase tracking-tight">
              {item.title}
            </h3>
            <span class="text-gray-400 text-xs mt-1">por {item.artist}</span>
          </div>
        </div>
      ))
    }
  </div>

  <div
    class="absolute bottom-0 left-6 right-6 md:left-0 md:right-0 h-[2px] bg-white/10 rounded-full overflow-hidden mt-4"
  >
    <div
      id="progress-bar"
      class="h-full bg-aux-secondary w-0 transition-all duration-100 ease-out origin-left"
    >
    </div>
  </div>

  <button
    id="arrow-left"
    class="hidden md:flex absolute top-1/2 -left-12 -translate-y-1/2 w-10 h-10 items-center justify-center border border-white/10 rounded-full text-white hover:bg-white/10 hover:border-aux-secondary transition-all duration-300 z-10"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-5 h-5"
      ><path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M15.75 19.5L8.25 12l7.5-7.5"></path></svg
    >
  </button>

  <button
    id="arrow-right"
    class="hidden md:flex absolute top-1/2 -right-12 -translate-y-1/2 w-10 h-10 items-center justify-center border border-white/10 rounded-full text-white hover:bg-white/10 hover:border-aux-secondary transition-all duration-300 z-10"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-5 h-5"
      ><path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M8.25 4.5l7.5 7.5-7.5 7.5"></path></svg
    >
  </button>
</div>

<script>
  import KeenSlider from "keen-slider";

  let sliderInstance;
  let allSlidesCache = [];
  const sliderElement = document.getElementById("keen-slider");
  const progressBar = document.getElementById("progress-bar");
  const leftArrow = document.getElementById("arrow-left");
  const rightArrow = document.getElementById("arrow-right");

  function initSlider() {
    if (!sliderElement) return;

    if (allSlidesCache.length === 0) {
      allSlidesCache = Array.from(sliderElement.children);
    }

    sliderInstance = new KeenSlider(sliderElement, {
      loop: false,
      mode: "snap",
      slides: {
        perView: 1.2,
        spacing: 16,
      },
      breakpoints: {
        "(min-width: 640px)": {
          slides: { perView: 2.2, spacing: 24 },
        },
        "(min-width: 1024px)": {
          slides: { perView: 3.5, spacing: 32 },
        },
      },
      created(s) {
        sliderElement.style.opacity = "1";
        updateNavigation(s);
        updateProgress(s);
      },
      slideChanged(s) {
        updateNavigation(s);
      },
      detailsChanged(s) {
        updateProgress(s);
        // IMPORTANTE: Chequear navegación en tiempo real para que desaparezca suavemente al llegar
        updateNavigation(s); 
      },
    });

    const newLeft = leftArrow.cloneNode(true);
    const newRight = rightArrow.cloneNode(true);
    leftArrow.parentNode.replaceChild(newLeft, leftArrow);
    rightArrow.parentNode.replaceChild(newRight, rightArrow);

    const currentLeft = document.getElementById("arrow-left");
    const currentRight = document.getElementById("arrow-right");

    currentLeft?.addEventListener("click", () => sliderInstance.prev());
    currentRight?.addEventListener("click", () => sliderInstance.next());
  }

  document.addEventListener("filter-gallery", (e) => {
    const category = e.detail.category;
    
    if (!sliderInstance || !sliderElement) return;

    sliderInstance.destroy();
    sliderElement.innerHTML = '';

    const filteredSlides = allSlidesCache.filter(slide => {
      const slideCat = slide.getAttribute('data-category');
      return category === 'all' || slideCat === category;
    });

    if (filteredSlides.length > 0) {
      filteredSlides.forEach(slide => sliderElement.appendChild(slide));
      
      if(progressBar) {
        progressBar.style.width = '0%';
        progressBar.style.transition = 'none';
        setTimeout(() => { progressBar.style.transition = ''; }, 50);
      }

      initSlider();
    }
  });

  function updateProgress(instance) {
    if (!progressBar) return;
    const progress = instance.track.details.progress;
    const width = Math.min(Math.max(progress * 100, 0), 100);
    progressBar.style.width = `${width}%`;
  }

  // --- FUNCIÓN CORREGIDA ---
  function updateNavigation(instance) {
    // Usamos el progreso (0 a 1) en lugar del índice
    const progress = instance.track.details.progress;
    
    const currentLeft = document.getElementById("arrow-left");
    const currentRight = document.getElementById("arrow-right");

    if (currentLeft) {
      // Si estamos al principio (0%)
      // Usamos <= 0.01 para cubrir márgenes de error pequeños
      if (progress <= 0.01) {
         currentLeft.classList.add('opacity-0', 'pointer-events-none');
      } else {
         currentLeft.classList.remove('opacity-0', 'pointer-events-none');
      }
    }
    
    if (currentRight) {
      // Si estamos al final (100% o casi)
      if (progress >= 0.99) {
         currentRight.classList.add('opacity-0', 'pointer-events-none');
      } else {
         currentRight.classList.remove('opacity-0', 'pointer-events-none');
      }
    }
  }

  initSlider();

  document.addEventListener("astro:page-load", () => {
    allSlidesCache = [];
    if (sliderInstance) sliderInstance.destroy();
    initSlider();
  });
</script>

<style>
  .keen-slider {
    cursor: grab;
  }
  .keen-slider:active {
    cursor: grabbing;
  }
</style>